name: Build Windows Application

on:
  push:
    branches: [ main, master, feature/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Download OpenCV
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/opencv/opencv/releases/download/4.8.0/opencv-4.8.0-windows.exe" -OutFile opencv.exe
        Start-Process -FilePath ".\opencv.exe" -ArgumentList "-y", "-gm2", "-o`"third_party`"" -Wait -NoNewWindow
        Remove-Item opencv.exe
    
    - name: Download ONNX Runtime
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-win-x64-1.16.3.zip" -OutFile onnx.zip
        Expand-Archive -Path onnx.zip -DestinationPath third_party -Force
        Rename-Item "third_party\onnxruntime-win-x64-1.16.3" "third_party\onnxruntime"
        Remove-Item onnx.zip
    
    - name: Configure CMake
      shell: cmd
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build
      shell: cmd
      run: |
        cd build
        cmake --build . --config Release
    
    - name: Package
      shell: powershell
      run: |
        powershell -ExecutionPolicy Bypass -File scripts/package.ps1
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OfflinePhotoEnhancer-Windows-x64
        path: dist/OfflinePhotoEnhancer.zip
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/OfflinePhotoEnhancer.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
